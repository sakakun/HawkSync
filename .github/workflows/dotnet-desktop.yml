name: Development Build and Publish

on:
  push:
    branches: [ master, main ]
    tags:
      - 'v*'
  pull_request:
    branches: [ master, main ]
  workflow_dispatch:

# Add permissions block
permissions:
  contents: write
  packages: write

env:
  SERVERMANAGER_PROJECT_PATH: BHD-ServerManager/ServerManager.csproj
  NETLIMITERBRIDGE_PROJECT_PATH: NetLimiterBridge/NetLimiterBridge.csproj
  OUTPUT_NAME: HawkSync-ServerManager
  DOTNET_VERSION: '8.0.x'

jobs:
  build:
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Setup .NET 8.0
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}

    - name: Setup .NET Framework Build Tools
      uses: microsoft/setup-msbuild@v2

    - name: Setup NuGet
      uses: nuget/setup-nuget@v2

    - name: Restore NetLimiterBridge dependencies
      run: nuget restore ${{ env.NETLIMITERBRIDGE_PROJECT_PATH }}

    - name: Restore ServerManager dependencies
      run: dotnet restore ${{ env.SERVERMANAGER_PROJECT_PATH }}

    - name: Build NetLimiterBridge (.NET Framework 4.8.1)
      run: |
        msbuild ${{ env.NETLIMITERBRIDGE_PROJECT_PATH }} `
          /p:Configuration=Release `
          /p:Platform="Any CPU" `
          /p:OutputPath=bin/Release/ `
          /p:PlatformTarget=x64

    - name: Build ServerManager (.NET 8.0)
      run: |
        dotnet build ${{ env.SERVERMANAGER_PROJECT_PATH }} `
          --configuration Release `
          --no-restore `
          /p:UseCommonOutputDirectory=false `
          /p:OutputPath=bin/Release/ `
          /p:BaseOutputPath=bin/ `
          /p:Platform="Any CPU"

    - name: Publish ServerManager
      run: |
        dotnet publish ${{ env.SERVERMANAGER_PROJECT_PATH }} `
          --configuration Release `
          --runtime win-x64 `
          --self-contained false `
          --output ./publish `
          /p:UseCommonOutputDirectory=false

    - name: Copy NetLimiterBridge to ServerManager output
      shell: pwsh
      run: |
        # Create NetLimiterBridge subfolder
        New-Item -ItemType Directory -Force -Path ./publish/NetLimiterBridge
        
        # Copy NetLimiterBridge binaries
        Copy-Item -Path ./NetLimiterBridge/bin/Release/* `
          -Destination ./publish/NetLimiterBridge/ `
          -Recurse -Force

    - name: Create version info
      shell: pwsh
      run: |
        $version = if ($env:GITHUB_REF -match 'refs/tags/v(.*)') { 
          $matches[1] 
        } else { 
          "dev-$(git rev-parse --short HEAD)" 
        }
        echo "VERSION=$version" >> $env:GITHUB_ENV
        
        @"
        Build Information
        =================
        Version: $version
        Build Date: $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss UTC')
        Commit: $(git rev-parse HEAD)
        Branch: $($env:GITHUB_REF -replace 'refs/heads/', '')
        
        Components:
        - ServerManager (.NET 8.0)
        - NetLimiterBridge (.NET Framework 4.8.1)
        
        Requirements:
        - .NET 8.0 Runtime
        - .NET Framework 4.8.1 Runtime
        - Windows 10/11 (x64)
        
        Download .NET 8.0 Runtime:
        https://dotnet.microsoft.com/download/dotnet/8.0
        
        Download .NET Framework 4.8.1 Runtime:
        https://dotnet.microsoft.com/download/dotnet-framework/net481
        "@ | Out-File -FilePath ./publish/BUILD_INFO.txt

    - name: Copy LICENSE to output
      shell: pwsh
      run: |
        if (Test-Path "LICENSE.txt") {
          Copy-Item LICENSE.txt ./publish/
        }

    - name: Create ZIP archive
      shell: pwsh
      run: |
        Compress-Archive -Path ./publish/* `
          -DestinationPath "./${{ env.OUTPUT_NAME }}-${{ env.VERSION }}.zip"

    - name: Upload Build Artifact
      uses: actions/upload-artifact@v4
      with:
        name: ${{ env.OUTPUT_NAME }}-${{ env.VERSION }}
        path: ./${{ env.OUTPUT_NAME }}-${{ env.VERSION }}.zip
        retention-days: 30

    - name: Create Release
      if: github.ref == 'refs/heads/master' || startsWith(github.ref, 'refs/tags/v')
      uses: softprops/action-gh-release@v2
      with:
        tag_name: ${{ startsWith(github.ref, 'refs/tags/v') && github.ref_name || format('dev-{0}', env.VERSION) }}
        name: ${{ startsWith(github.ref, 'refs/tags/v') && format('Release {0}', github.ref_name) || format('Development Build {0}', env.VERSION) }}
        files: ./${{ env.OUTPUT_NAME }}-${{ env.VERSION }}.zip
        body: |
          ## HawkSync Server Manager ${{ env.VERSION }}
          
          ### Requirements
          - Windows 10/11 (x64)
          - [.NET 8.0 Runtime](https://dotnet.microsoft.com/download/dotnet/8.0)
          - [.NET Framework 4.8.1 Runtime](https://dotnet.microsoft.com/download/dotnet-framework/net481)
          
          ### Installation
          1. Install .NET 8.0 Runtime if not already installed
          2. Install .NET Framework 4.8.1 Runtime if not already installed
          3. Download the ZIP file below
          4. Extract to your desired location
          5. Run `ServerManager.exe`
          
          ### Components
          - **ServerManager**: Main application (.NET 8.0)
          - **NetLimiterBridge**: Network limiting bridge (.NET Framework 4.8.1)
          
          ### Changes
          See [commit history](https://github.com/${{ github.repository }}/commits/${{ github.ref_name }}) for details.
        draft: false
        prerelease: ${{ !startsWith(github.ref, 'refs/tags/v') }}
        generate_release_notes: true
        make_latest: ${{ startsWith(github.ref, 'refs/tags/v') }}
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}