# Database Migration Architecture

## System Overview

```
???????????????????????????????????????????????????????????????????????
?                    APPLICATION STARTUP                               ?
?                                                                       ?
?  DatabaseManager.Initialize()                                        ?
?         ?                                                            ?
?  UpgradeDatabase()                                                   ?
???????????????????????????????????????????????????????????????????????
                              ?
         ??????????????????????????????????????
         ?  Check Schema Version              ?
         ?  Current: From tb_settings         ?
         ?  Target: CURRENT_SCHEMA_VERSION    ?
         ??????????????????????????????????????
                              ?
                    ???????????????????
                    ? Version Match?  ?
                    ???????????????????
                      ?            ?
                     YES          NO
                      ?            ?
              ????????????   ????????????????????????
              ?   Done   ?   ?  UPGRADE NEEDED      ?
              ????????????   ????????????????????????
                                      ?
                        ????????????????????????????
                        ?  1. Create Backup        ?
                        ?     database.sqlite      ?
                        ?     ? backup_TIMESTAMP   ?
                        ????????????????????????????
                                      ?
                        ????????????????????????????
                        ?  2. Read SQL File        ?
                        ?     database.sqlite.sql  ?
                        ????????????????????????????
                                      ?
                        ????????????????????????????
                        ?  3. Parse Statements     ?
                        ?     - CREATE TABLE       ?
                        ?     - CREATE INDEX       ?
                        ????????????????????????????
                                      ?
                        ????????????????????????????
                        ?  4. Apply Changes        ?
                        ?  (Within Transaction)    ?
                        ?                          ?
                        ?  For each table:         ?
                        ?   • Exists? ? Add cols   ?
                        ?   • New? ? Create it     ?
                        ?                          ?
                        ?  For each index:         ?
                        ?   • Create IF NOT EXISTS ?
                        ????????????????????????????
                                      ?
                        ????????????????????????????
                        ?  5. Custom Migrations    ?
                        ?     (If needed)          ?
                        ?  ApplyCustomMigrations() ?
                        ????????????????????????????
                                      ?
                        ????????????????????????????
                        ?  6. Update Version       ?
                        ?  tb_settings             ?
                        ?  schema_version = N      ?
                        ????????????????????????????
                                      ?
                        ????????????????????????????
                        ?  7. COMMIT               ?
                        ?     ? Success           ?
                        ?  OR                      ?
                        ?     ROLLBACK             ?
                        ?     ? Failed            ?
                        ????????????????????????????
```

## Data Flow

```
????????????????????????
? database.sqlite.sql  ?  ? YOU EDIT THIS (source of truth)
? (Schema Definition)  ?
????????????????????????
          ?
   [Parse & Extract]
          ?
????????????????????????       ???????????????????????
? CREATE TABLE stmts   ?       ? CREATE INDEX stmts  ?
????????????????????????       ???????????????????????
          ?                              ?
   [Compare with DB]              [Apply to DB]
          ?                              ?
????????????????????????       ???????????????????????
? Table exists?        ?       ? IF NOT EXISTS ?     ?
?  YES ? Add columns   ?       ? Safe to execute     ?
?  NO  ? Create table  ?       ???????????????????????
????????????????????????
          ?
????????????????????????
?  database.sqlite     ?  ? AUTOMATICALLY UPDATED
?  (Live Database)     ?
????????????????????????
```

## Key Components

### DatabaseManager.cs

| Method | Purpose |
|--------|---------|
| `UpgradeDatabase()` | Main orchestrator - checks version and coordinates upgrade |
| `ApplySchemaFromSqlFile()` | Reads SQL file and applies CREATE statements |
| `ParseSqlStatements()` | Splits SQL file into individual statements |
| `ExtractTableName()` | Extracts table name from CREATE TABLE |
| `ParseColumnDefinitions()` | Extracts column definitions from CREATE TABLE |
| `AddMissingColumns()` | Compares schema and adds missing columns |
| `ApplyCustomMigrations()` | Handles complex migrations (rename, type change, etc.) |
| `CreateDatabaseBackup()` | Creates timestamped backup before upgrade |
| `GetSchemaVersion()` | Reads current version from tb_settings |
| `SetSchemaVersion()` | Updates version in tb_settings |

### Helper Methods (Available in Custom Migrations)

| Method | Usage |
|--------|-------|
| `TableExists()` | `if (TableExists(conn, tx, "tb_myTable"))` |
| `ColumnExists()` | `if (ColumnExists(conn, tx, "tb_users", "Email"))` |
| `IndexExists()` | `if (IndexExists(conn, tx, "idx_users_email"))` |

## Migration Safety Features

### 1. Automatic Backup
- Created before any migration starts
- Timestamped filename
- Can be restored manually if needed

### 2. Transaction-Based
- All changes in single transaction
- Any error triggers complete rollback
- Database remains in consistent state

### 3. Idempotent Operations
- `CREATE IF NOT EXISTS` - safe to run multiple times
- Column existence checks before ALTER TABLE
- Index checks before creation

### 4. Data Preservation
- Existing tables are never dropped (unless explicitly in custom migration)
- New columns use DEFAULT values
- Foreign keys preserved

### 5. Validation
- File existence check before reading SQL
- Statement parsing with error handling
- Column compatibility validation

## Comparison: Old vs New Approach

| Aspect | Old Approach | New Approach (SQL File-Based) |
|--------|-------------|-------------------------------|
| Schema Source | Hardcoded in C# methods | database.sqlite.sql file |
| Adding Tables | Write C# migration code | Update SQL file + increment version |
| Adding Columns | Write C# migration code | Update SQL file + increment version |
| Adding Indexes | Write C# migration code | Update SQL file + increment version |
| Maintenance | Must update C# + SQL file | Update SQL file only (single source) |
| Testing | Requires recompile | Can test SQL file directly |
| Complexity | More boilerplate code | Minimal code, more automation |
| Custom Migrations | Same method | ApplyCustomMigrations() for edge cases |

## Example Upgrade Scenarios

### Scenario 1: Add New Feature Table

**Before** (database.sqlite.sql v1):
```sql
-- Existing schema
CREATE TABLE IF NOT EXISTS tb_users (...);
```

**After** (database.sqlite.sql v2):
```sql
-- Existing schema
CREATE TABLE IF NOT EXISTS tb_users (...);

-- NEW: Feature flags
CREATE TABLE IF NOT EXISTS tb_featureFlags (
    FlagID INTEGER PRIMARY KEY AUTOINCREMENT,
    FlagName TEXT NOT NULL UNIQUE,
    IsEnabled INTEGER DEFAULT 1
);
CREATE INDEX IF NOT EXISTS idx_featureFlags_name ON tb_featureFlags(FlagName);
```

**C# Change**:
```csharp
private const int CURRENT_SCHEMA_VERSION = 2; // Was 1
```

**Result**: On startup, `tb_featureFlags` table and index are automatically created.

---

### Scenario 2: Add Column to Existing Table

**Before** (database.sqlite.sql v2):
```sql
CREATE TABLE IF NOT EXISTS tb_users (
    UserID INTEGER PRIMARY KEY AUTOINCREMENT,
    Username TEXT NOT NULL,
    PasswordHash TEXT NOT NULL
);
```

**After** (database.sqlite.sql v3):
```sql
CREATE TABLE IF NOT EXISTS tb_users (
    UserID INTEGER PRIMARY KEY AUTOINCREMENT,
    Username TEXT NOT NULL,
    PasswordHash TEXT NOT NULL,
    Email TEXT DEFAULT '',           -- NEW
    PhoneNumber TEXT DEFAULT ''      -- NEW
);
```

**C# Change**:
```csharp
private const int CURRENT_SCHEMA_VERSION = 3; // Was 2
```

**Result**: On startup, `Email` and `PhoneNumber` columns are automatically added to existing `tb_users` table with empty defaults. All existing user records are preserved.

---

### Scenario 3: Complex Change (Rename Column)

**SQL File Change** (database.sqlite.sql v4):
```sql
CREATE TABLE IF NOT EXISTS tb_users (
    UserID INTEGER PRIMARY KEY AUTOINCREMENT,
    Username TEXT NOT NULL,
    PasswordHash TEXT NOT NULL,
    EmailAddress TEXT DEFAULT ''  -- Renamed from Email
);
```

**C# Changes**:
```csharp
private const int CURRENT_SCHEMA_VERSION = 4;

// In ApplyCustomMigrations():
case 4:
    RenameEmailColumn(conn, tx);
    break;

private static void RenameEmailColumn(SqliteConnection conn, SqliteTransaction tx)
{
    if (!ColumnExists(conn, tx, "tb_users", "EmailAddress"))
    {
        // Recreate table with new structure
        // ... complex migration logic ...
    }
}
```

**Result**: Custom migration handles the column rename, preserving all data.

## Performance Notes

- Schema checks happen only once at startup
- Backup creation is fast (file copy)
- Migrations are typically < 1 second for small databases
- Large databases (>1GB) may take longer for backups
- All changes happen in-memory within transaction (fast)

## Security Considerations

- Backup files contain all data (protect access)
- SQL file is parsed, not executed directly (safer)
- Transaction rollback prevents partial updates
- No external network access during migration
- All operations logged for audit trail
